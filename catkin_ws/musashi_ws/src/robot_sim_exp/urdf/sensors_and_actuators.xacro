<?xml version="1.0"?>
<robot name="musashi_robot" xmlns:xacro="http://ros.org/wiki/xacro">

<!-- ///////////////////////////////////////// STEERING //////////////////////////////////// -->

<!-- CONTINOUS -->
  <xacro:macro name="steering" params="name parent mass sizex sizey sizez ox oy oz filename">
    <link name="${name}">
      <visual>
        <geometry>
	  <mesh filename="${filename}"/>
	</geometry>
	<origin rpy="0 0 0" xyz="${-ox} ${-oy} ${-oz}" />
      </visual>
      <xacro:inertial_box mass="${mass}" x="${sizex}" y="${sizey}" z="${sizez}" />
    </link>
    <joint name="${parent}_to_${name}" type="continuous">
      <parent link="${parent}"/>
      <child link="${name}"/>
      <origin xyz="${ox} ${oy} ${oz}" />
      <axis xyz="0 0 1" />
    </joint>
    <transmission name="${name}_trans">
      <type>transmission_interface/SimpleTransmission</type>
      <actuator name="${name}_motor">
        <mechanicalReduction>1</mechanicalReduction>
	<hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
      </actuator>
      <joint name="${parent}_to_${name}" type="continuous">
        <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
      </joint>
    </transmission>
  </xacro:macro>


<!-- FIXED -->
  <xacro:macro name="steering_fixed" params="name parent mass sizex sizey sizez ox oy oz filename">
    <link name="${name}">
      <visual>
        <geometry>
	  <mesh filename="${filename}"/>
	</geometry>
	<origin rpy="0 0 0" xyz="${-ox} ${-oy} ${-oz}" />
      </visual>
      <xacro:inertial_box mass="${mass}" x="${sizex}" y="${sizey}" z="${sizez}" />
    </link>
    <joint name="${parent}_to_${name}" type="fixed">
      <parent link="${parent}"/>
      <child link="${name}"/>
      <origin xyz="${ox} ${oy} ${oz}" />
      <axis xyz="0 0 1" />
    </joint>
  </xacro:macro>

<!-- ///////////////////////////////////////// WHEELS //////////////////////////////////// -->

  <xacro:macro name="wheels" params="name parent mass length radius ox oy oz mu1 mu2 kp kd filename" >
    <link name="${name}" >
      <visual>
        <geometry>
	  <mesh filename="${filename}"/>
	</geometry>
	<origin rpy="0 0 0" xyz="${-ox} ${-oy} ${-oz}" />
      </visual>
      <collision>
        <geometry>
	  <mesh filename="${filename}"/>
	</geometry>
	<origin rpy="0 0 0" xyz="${-ox} ${-oy} ${-oz}" />
      </collision>
      <xacro:inertial_zylinder_y mass="${mass}" radius="${radius}" height="${length}" />
    </link>
    <gazebo reference="${name}" >
      <mu1 value="${mu1}"/>
      <mu2 value="${mu2}"/>
      <kp value="${kp}" />
      <kd value="${kd}" />
    </gazebo>
    <joint name="${parent}_to_${name}" type="continuous">
      <parent link="${parent}" />
      <child link="${name}" />
      <axis xyz="0 1 0" />
      <origin xyz="0.0 0.0 ${oz}" />
    </joint>
    <transmission name="${name}_trans">
      <type>transmission_interface/SimpleTransmission</type>
      <actuator name="${name}_motor">
        <mechanicalReduction>1</mechanicalReduction>
	<!--<hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>-->
      </actuator>
      <joint name="${parent}_to_${name}">
        <hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>
      </joint>
    </transmission>
  </xacro:macro>
  
<!-- /////////////////////////////////////////////////////////////////// -->

<!-- ////////////////////////////// Lidar ////////////////////////////// -->

  <xacro:macro name="lidar_sensor" params="parent lidar_name length radius mass ox oy oz update_rate min_angle max_angle min_range max_range range_resolution stdv" >
    <link name="${lidar_name}">
	  <visual>
	    <geometry>
		  <cylinder length="${length}" radius="${radius}"/>
		</geometry>
		<origin rpy="0 0 0" xyz="0 0 0"/>
		<material name="Black"/>
	  </visual>
	  <xacro:inertial_zylinder_z mass="${mass}" radius="${radius}" height="${length}" />
	</link>
	<gazebo reference="${lidar_name}">
      <material>Gazebo/Black</material>
  	</gazebo>
	<joint name="$[parent}_to_${lidar_name}" type="fixed">
	  <parent link="${parent}"/>
      <child link="${lidar_name}"/>
	  <origin xyz="${ox} ${oy} ${oz}"/>
	</joint>

	<!-- RPLidar -->
  	<gazebo reference="${lidar_name}">
      <sensor type="ray" name="head_hokuyo_sensor">
        <pose>0 0 0 0 0 0</pose>
	<visualize>false</visualize>
      	<update_rate>${update_rate}</update_rate>
      	<ray>
          <scan>
            <horizontal>
	      <samples>400</samples>
              <resolution>1</resolution>
              <min_angle>${min_angle}</min_angle>
              <max_angle>${max_angle}</max_angle>
          	</horizontal>
          </scan>
          <range>
            <min>${min_range}</min>
            <max>${max_range}</max>
          	<resolution>${range_resolution}</resolution>
          </range>
          <noise>
            <type>gaussian</type>
          	<!-- Noise parameters based on published spec for Hokuyo laser
               	achieving "+-30mm" accuracy at range < 10m.  A mean of 0.0m and
               	stddev of 0.01m will put 99.7% of samples within 0.03m of the true
               	reading. -->
          	<mean>0.0</mean>
          	<stddev>${stdv}</stddev>
          </noise>
      	</ray>
      	<plugin name="gazebo_ros_head_hokuyo_controller" filename="libgazebo_ros_laser.so">
          <topicName>/lidar/scan</topicName>
          <frameName>lidar</frameName>
      	</plugin>
      </sensor>
    </gazebo>
  </xacro:macro>

<!-- /////////////////////////////////////////////////////////////////// -->

<!-- ////////////////////////////// IMU ////////////////////////////// -->

  <xacro:macro name="imu_sensor" params="parent imu_name mass sizex sizey sizez ox oy oz update_rate update_rateHz noise" >
    <link name="${imu_name}">
	  <visual>
	    <geometry>
	      <box size="${sizex} ${sizey} ${sizez}"/>
		</geometry>
	    <material name="White"/>
	  </visual>
	  <xacro:inertial_box mass="${mass}" x="${sizex}" y="${sizey}" z="${sizez}" />
    </link>
	<joint name="${parent}_to_${imu_name}" type="fixed">
	  <parent link="${parent}"/>
	  <child link="${imu_name}"/>
	  <origin xyz="${ox} ${oy} ${oz}"/>
	</joint>
        <!-- maybe switch to the Hector version of the IMU -->
    <gazebo reference="${imu_name}">
      <material>Gazebo/White</material>
	  <gravity>true</gravity>
	  <sensor name="${imu_name}_sensor" type="imu">
	    <always_on>true</always_on>
	    <update_rate>${update_rate}</update_rate>
	    <visualize>true</visualize>
	    <topic>__default_topic__</topic>
  		<plugin filename="libgazebo_ros_imu_sensor.so" name="imu_plugin">
		  <topicName>imu/data_raw</topicName>
                  <bodyName>${imu_name}</bodyName>
		  <updateRateHZ>${update_rateHz}</updateRateHZ>
                  <gaussianNoise>${noise}</gaussianNoise>
		  <xyzOffset>0 0 0</xyzOffset>
		  <rpyOffset>0 0 0</rpyOffset>
                  <frameName>${imu_name}</frameName>
	    </plugin>
	    <pose>0 0 0 0 0 0</pose>
	  </sensor>
    </gazebo>
  </xacro:macro>

<!-- ///////////////////////////////////////////////////////////////// -->

</robot>
