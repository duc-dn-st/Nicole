include(FetchContent)
include(ExternalProject)

set(BLASFEO_SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/blasfeo)
set(BLASFEO_SUBBUILD_DIR ${CMAKE_CURRENT_SOURCE_DIR}/blasfeo-subbuild)
set(BLASFEO_INSTALL_DIR ${CMAKE_CURRENT_SOURCE_DIR}/blasfeo-install)
set(BLASFEO_HEADERS_INSTALLATION_DIR ${PROJECT_SOURCE_DIR}/include/hpipm-cpp/blasfeo)

FetchContent_GetProperties(external_blasfeo)
if(NOT external_blasfeo_POPULATED)
FetchContent_Populate(
  external_blasfeo
  GIT_REPOSITORY https://github.com/giaf/blasfeo.git 
  GIT_TAG        master
  SOURCE_DIR ${BLASFEO_SOURCE_DIR}
  SUBBUILD_DIR ${BLASFEO_SUBBUILD_DIR}
)
endif()
ExternalProject_Add(
  external_blasfeo
  SOURCE_DIR ${BLASFEO_SOURCE_DIR}
  BUILD_IN_SOURCE TRUE
  INSTALL_DIR ${BLASFEO_INSTALL_DIR} 
  CONFIGURE_COMMAND ${CMAKE_COMMAND} -DCMAKE_INSTALL_PREFIX=<INSTALL_DIR> -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} -DBUILD_SHARED_LIBS=ON -DBLASFEO_EXAMPLES=OFF -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DBLASFEO_HEADERS_INSTALLATION_DIRECTORY=${BLASFEO_HEADERS_INSTALLATION_DIR}
)

set(HPIPM_SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/hpipm)
set(HPIPM_SUBBUILD_DIR ${CMAKE_CURRENT_SOURCE_DIR}/hpipm-subbuild)
set(HPIPM_INSTALL_DIR ${CMAKE_CURRENT_SOURCE_DIR}/hpipm-install)
set(HPIPM_HEADERS_INSTALLATION_DIR ${PROJECT_SOURCE_DIR}/include/hpipm-cpp/hpipm)

FetchContent_GetProperties(external_hpipm)
if(NOT external_hpipm_POPULATED)
  FetchContent_Populate(
  external_hpipm 
  GIT_REPOSITORY https://github.com/giaf/hpipm.git 
  GIT_TAG        master
  SOURCE_DIR ${HPIPM_SOURCE_DIR}
  SUBBUILD_DIR ${HPIPM_SUBBUILD_DIR}
)
endif()
ExternalProject_Add(
  external_hpipm
  SOURCE_DIR ${HPIPM_SOURCE_DIR}
  BUILD_IN_SOURCE TRUE
  INSTALL_DIR  ${HPIPM_INSTALL_DIR}
  CONFIGURE_COMMAND ${CMAKE_COMMAND} -DCMAKE_INSTALL_PREFIX=<INSTALL_DIR> -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} -DBUILD_SHARED_LIBS=ON -DHPIPM_TESTING=OFF -DCMAKE_POSITION_INDEPENDENT_CODE=ON -DBLASFEO_PATH=${BLASFEO_INSTALL_DIR} -DBLASFEO_INCLUDE_DIR=${BLASFEO_HEADERS_INSTALLATION_DIR} -DHPIPM_HEADERS_INSTALLATION_DIRECTORY=${HPIPM_HEADERS_INSTALLATION_DIR}
)
add_dependencies(external_hpipm external_blasfeo)